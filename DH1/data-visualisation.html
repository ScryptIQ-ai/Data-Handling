<!DOCTYPE html>
<html>
<head>
    <!-- MathJax for mathematical notation -->
    <script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']],
            processEscapes: true
        },
        svg: {
            fontCache: 'global'
        }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <!-- Pyodide and CodeMirror -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/pastel-on-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="192x192" href="../assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../assets/android-chrome-512x512.png">
    
    <!-- Core Stylesheets -->
    <link rel="stylesheet" href=../assets/colours-l2d.css>
    <link rel="stylesheet" href="../assets/shared-styles.css">
    <link rel="stylesheet" href="../assets/nav-bar.css">
    <link rel="stylesheet" href="../assets/module_card.css">
    <link rel="stylesheet" href="../assets/learning_outcomes.css">
    <link rel="stylesheet" href="../assets/learning_lists.css">
    <link rel="stylesheet" href="../assets/box_styles.css">
    <link rel="stylesheet" href="../assets/code_styles.css">

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2D - DH1 - Visualisation of data</title>
    
    <!-- File URLs for this lesson -->
    <script>
        window.LESSON_FILES = [
            {url: "https://raw.githubusercontent.com/ScryptIQ-ai/lesson-data/refs/heads/main/dh/everleys_data.csv", filename: "everleys_data.csv", is_binary: false},
            {url: "https://raw.githubusercontent.com/ScryptIQ-ai/lesson-data/refs/heads/main/dh/loan_data.csv", filename: "loan_data.csv", is_binary: false}
        ];
        window.LESSON_PACKAGES = ['pandas', 'matplotlib'];
    </script>
        
</head>
<body>
    
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <a href="../homepage.html" style="text-decoration: none; display: inline-block;">
                <img src="../assets/l2d-brain-logo.png" alt="scryptIQ Logo" class="sidebar-logo">
            </a>
        </div>

        <h3>Content</h3>
        <ul>
            <li><a href="./introduction.html" class="">Introduction</a></li><li><a href="./pandas.html">Pandas</a></li><li><a href="./data-features.html">Data features</a></li>
            <li>
                <div class="nav-toggle active" data-target="expandable-section-3">
                    Visualisation of data
                    <span class="toggle-icon">▼</span>
                </div>
                <ul class="nested-nav expanded" id="expandable-section-3"><li><a href="#introduction">Introduction</a></li><li><a href="#visualisation-with-pandas">Visualisation with Pandas</a></li><li><a href="#plots-using-matplotlib">Plots using Matplotlib</a></li><li><a href="#histogram">Histogram</a></li><li><a href="#summary">Summary</a></li>
                </ul>
            </li><li><a href="./diabetes-dataset.html">Diabetes Dataset</a></li><li><a href="./assignment.html">Assignment</a></li><li><a href="./feedback.html">Feedback</a></li>
        </ul>

        <h3 class="collapsible-header collapsed">
            Resources
            <span class="collapse-icon">►</span>
        </h3>
        <div class="collapsible-content collapsed">
            <ul>
                <li><a href="./glossary.html">Glossary</a></li><li><a href="./downloads.html">Downloads</a></li><li><a href="../HB/introduction.html">Handbook</a></li>
            </ul>
        </div>

        <h3>
            <li><a href="./report-issue.html">Report an Issue</a></li>
        </h3>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle">❮</button>
    
    <!-- Main Content Area -->
    <div id="main-content" class="main-content">
        <!-- Top Navigation Bar -->
        <div class="top-navbar">
            <h1 class="page-title">Data Handling 1</h1>
            <div class="nav-actions">
                <a href="../homepage.html" class="text-button" title="Materials homepage">
                    Homepage
                </a>
                <a href="https://learntodiscover.ai/my-cohorts/" class="text-button" title="Find out more about us">
                    Learn to Discover
                </a>
            </div>
        </div>

        
            <div class="module-card" id="introduction">
                <div class="module-header">
                    Visualisation of data <span class="module-tag">DH1</span>
                </div>
                <div class="module-body">
                    <h3>Learning Objectives</h3>
                    <div class="learning-outcomes">
                        <div class="outcome-item">
                    <span class="outcome-number">1</span>
                    <span class="outcome-text">How to plot data with Pandas</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">2</span>
                    <span class="outcome-text">How to plot data with Matplotlib</span>
                </div>
                    </div>
                    <h3>Introduction</h3>
                    <p>At the end of all good science is a visualisation or figure that best represents the story of your data. With Python and pandas, you can easily produce plots to describe your data with a single line of code, making it a superb tool for data exploration as well as producing the finished product. Pandas has a built-in backend for plotting data contained within a DataFrame; however, Matplotlib offers greater control. We will introduce both here, but afterwards we will stick to Matplotlib. Many of the visualisations shown here will be very basic, but as you progress in your mastery of Python you can begin to create complex, visually appealing plots that are unique to your data. The toolsets given here open up a lot of freedom to create plots the way you want.</p>
                </div>
            </div>
            
            <div class="module-card" id="visualisation-with-pandas">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Visualisation with Pandas</h3>
                        <p>Previously, it was easy to see in the diabetes dataset that the concentrations of sodium are much higher than those of calcium, just from viewing the Dataframe. However, to incorporate comparisons of medians, percentiles and the spread of the data, it is better to use visualisation.<br><br>The simplest way to visualise data, is to use Pandas&#x27; functionality which offers direct methods of plotting your data. Here is an example where a boxplot is created for each column:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-40"># Once again lets load in our dataset
from pandas import read_csv

df = read_csv(&quot;./data/everleys_data.csv&quot;)</textarea>
            </div>
            <div id="code-cell-40-output" class="output" style="display: none;"></div>
        </div>
        <p>Data visualisation tools can&#x27;t always handle <code>null</code> / <code>NaN</code> values, so it&#x27;s good practice to remove first.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-41"># Repeat the steps from the previous section
replacement_values = {&quot;calcium&quot; : 0, &quot;sodium&quot; : 0}
df = df.fillna(value = replacement_values)</textarea>
            </div>
            <div id="code-cell-41-output" class="output" style="display: none;"></div>
        </div>
        <p>To have pandas plots render properly in Jupyter Notebooks we need to execute a magic Python command.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-42">%matplotlib inline</textarea>
            </div>
            <div id="code-cell-42-output" class="output" style="display: none;"></div>
        </div>
        
        <div class="info-box fact-box">
            <div class="box-title">
                <span class="box-icon"></span>
                FACT
            </div>
            <div class="box-content">
                <p><a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">Magic commands</a> are specific to IPython (interactive Python), which is what we have in Jupyter notebooks. They allow you special commands in IPython that provide special functionalities to users, like modifying the behavior how figures render.</p>
            </div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-43">df.boxplot()</textarea>
            </div>
            <div id="code-cell-43-output" class="output"></div>
        </div>
        <p>By default, boxplots are shown for all columns if no further argument is given to the function (empty round parentheses). As the calcium plot is quite condensed, we may wish to visualise it, separately. This can be done by specifying the calcium column as an argument:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-44">df.boxplot(column=&#x27;calcium&#x27;);</textarea>
            </div>
            <div id="code-cell-44-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="plots-using-matplotlib">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Plots using Matplotlib</h3>
                        
        <div class="video-container">
            <iframe 
                src="https://www.youtube.com/embed/mljXcIzx4ps"
                width="560"
                height="315"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
            </iframe>
        </div>
        <p><a href="https://matplotlib.org/">Matplotlib</a> is a comprehensive library for creating static, animated and interactive visualizations in Python.<br><br>The above is an easy way to create boxplots directly on the DataFrame. It is based on the library Matplotlib and specifically uses the pyplot library. For simplicity, this code is put into a convenient Pandas function.<br><br>However, we are going to use Matplotlib extensively later on in the course, and we will therefore start by introducing a more direct and generic way of using it.<br><br>To do this, we import the function subplots from the <a href="https://matplotlib.org/stable/api/pyplot_summary.html">pyplot module</a> of matplotlib:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-45">from matplotlib.pyplot import subplots, show</textarea>
            </div>
            <div id="code-cell-45-output" class="output" style="display: none;"></div>
        </div>
        
        <div class="info-box note-box">
            <div class="box-title">
                <span class="box-icon"></span>
                NOTE
            </div>
            <div class="box-content">
                <p>Matplotlib is not included in the standard library, you must first install it to your working Python environment. We have already done this for you in your Codespace.</p>
            </div>
        </div>
        <p>The way to use subplots is to first set up a figure environment (below referred to in the code as an object titled &#x27;fig&#x27;) and an empty coordinate system (below referred to as object <code>ax</code>). The plot is then created using one of the many methods available in Matplotlib. We will proceed by applying it to the coordinate system, <code>ax</code>.<br><br>As an example, let us create a <a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.boxplot.html#matplotlib.pyplot.boxplot%7C">boxplot</a> of the calcium variable. As an argument of the function we need to specify the data. We can use the values of the &#x27;calcium&#x27; concentrations from the column with the same name:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-46">fig, ax = subplots()
ax.boxplot(df[&#x27;calcium&#x27;].tolist())

# Pass a string to .set_title() to create a title 
ax.set_title(&#x27;Boxplot of Everley Calcium&#x27;)

# Pass a list of strings to set_xticklabels() to label the x-axis
ax.set_xticklabels([&#x27;calcium&#x27;]); # A semi colon is used here to suppress the output of this line

show()</textarea>
            </div>
            <div id="code-cell-46-output" class="output"></div>
        </div>
        <p>Note how we define the title of the plot by referring to the same coordinate system <code>ax</code>.<br><br>The value of subplots becomes apparent when it is used to generate more than one plot as part of a single figure: one of its many useful features.<br><br>Here is an example whereby we create two boxplots adjacent to each other. The keyword arguments to use is <code>ncols</code> which is the number of figures per row. <code>ncols=2</code> indicates that you are plotting two plots adjacent to each other.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-47">fig, ax = subplots(ncols=2)
ax[0].boxplot(df[&#x27;calcium&#x27;])
ax[0].set_title(&#x27;Calcium&#x27;)
ax[0].set_xticklabels([&#x27;calcium&#x27;])

ax[1].boxplot(df[&#x27;sodium&#x27;])
ax[1].set_title(&#x27;Sodium&#x27;)
ax[1].set_xticklabels([&#x27;sodium&#x27;])

# We can also add a title for the whole figure
fig.suptitle(&#x27;Boxplots of Calcium and Sodium&#x27;, fontsize=14)

show()</textarea>
            </div>
            <div id="code-cell-47-output" class="output"></div>
        </div>
        <p>Each of these subplots must now be referred to using indexing the coordinate system <code>ax</code>. This figure gives a good overview of the Everley&#x27;s data.<br><br>If you prefer to have the boxplots of both columns in a single figure, this can also be done:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-48">fig, ax = subplots(ncols=1, nrows=1)
ax.boxplot([df[&#x27;calcium&#x27;], df[&#x27;sodium&#x27;]], positions=[1, 2])
ax.set_title(&#x27;Boxplot of Calcium (left) and Sodium (right)&#x27;)

# When plotting all columns in a dataframe you can call .columns to set the labels
ax.set_xticklabels(df.columns)

show()</textarea>
            </div>
            <div id="code-cell-48-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="plots-using-matplotlib">
                <div class="module-body">
                    <div class="module-section">
                        
        <div class="info-box practice-exercise-box">
            <div class="box-title">
                <span class="box-icon"></span>
                PRACTICE EXERCISE
            </div>
            <div class="box-content">
                <p><strong>1.</strong></p>
                <p>Using the Loan dataset, plot the boxplots of the <code>ApplicantIncome</code> and the <code>CoapplicantIncome</code>.</p>
            </div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-editor">
                <textarea id="code-cell-49"># Write your code here:</textarea>
            </div>
            <button id="run-code-cell-49" class="run-button">Run Code</button>
            <div id="code-cell-49-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="histogram">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Histogram</h3>
                        <p>Another good visual overview for data is the histogram. Containers or &#x27;bins&#x27; are created over the range of values found within a column, and the count of the values for each bin is plotted on the vertical (y-)axis.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-50">fig, ax = subplots(ncols=2, nrows=1)

ax[0].hist(df[&#x27;calcium&#x27;])
ax[0].set(xlabel=&#x27;Calcium&#x27;, ylabel=&#x27;Count&#x27;)
ax[1].hist(df[&#x27;sodium&#x27;])
ax[1].set(xlabel=&#x27;Sodium&#x27;, ylabel=&#x27;Count&#x27;)

fig.suptitle(&#x27;Histograms of Everley concentrations&#x27;, fontsize=15);

show()</textarea>
            </div>
            <div id="code-cell-50-output" class="output"></div>
        </div>
        <p>This example code also demonstrates how to use methods from within subplots to add labels to the axes, together with a title for the overall figure.<br><br>Unless specified, a default value is used for the generation of the bins. It is set to 10 bins over the range of which values are found. The number of bins in the histogram can be changed using the keyword argument &#x27;bins&#x27;:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-51">fig, ax = subplots(ncols=2, nrows=1)

ax[0].hist(df[&#x27;calcium&#x27;], bins=5)
ax[0].set(xlabel=&#x27;Calcium, 5 bins&#x27;, ylabel=&#x27;Count&#x27;)
ax[1].hist(df[&#x27;calcium&#x27;], bins=15)
ax[1].set(xlabel=&#x27;Calcium, 15 bins&#x27;, ylabel=&#x27;Count&#x27;)

fig.suptitle(&#x27;Histograms with Different Binnings&#x27;, fontsize=16);

show()</textarea>
            </div>
            <div id="code-cell-51-output" class="output"></div>
        </div>
        <p>Note how the y-axis label of the right figure is slightly misplaced, and overlapping the border of the left figure. In order to correct for the placement of the labels and the title, you can use <code>tight_layout</code> automatically adjust for this:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-52">fig, ax = subplots(ncols=2, nrows=1)
ax[0].hist(df[&#x27;calcium&#x27;], bins=5)
ax[0].set(xlabel=&#x27;Calcium, 5 bins&#x27;, ylabel=&#x27;Count&#x27;);
ax[1].hist(df[&#x27;calcium&#x27;], bins=15)
ax[1].set(xlabel=&#x27;Calcium, 15 bins&#x27;, ylabel=&#x27;Count&#x27;);
fig.suptitle(&#x27;Histograms with Different Binnings&#x27;, fontsize=16);
fig.tight_layout()
show()</textarea>
            </div>
            <div id="code-cell-52-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="histogram">
                <div class="module-body">
                    <div class="module-section">
                        
        <div class="info-box practice-exercise-box">
            <div class="box-title">
                <span class="box-icon"></span>
                PRACTICE EXERCISE
            </div>
            <div class="box-content">
                <p><strong>2.</strong></p>
                <p>Take the loan data and display the histogram of the loan amount that people asked for. (Loan amounts are divided by 1000, i.e. in k£ on the horizontal axis). Use 20 bins, as an example.</p>
            </div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-editor">
                <textarea id="code-cell-53"># Write your code here:</textarea>
            </div>
            <button id="run-code-cell-53" class="run-button">Run Code</button>
            <div id="code-cell-53-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="summary">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Summary</h3>
                        <p>The simplest method for data visualisation is to use Pandas&#x27; in-built functionality. However, using Matplotlib is the preferred method for visualisation due its comprehensive library for creating static, animated, and interactive visualisations in Python. Have a play around with Matplotlib with your own data to see its power.</p>
                    </div>
                </div>
            </div>
            
        
        <div class="page-navigation">
            <a href="./data-features.html" class="nav-button prev">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                Previous
            </a>
            <a href="./diabetes-dataset.html" class="nav-button next">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </a></div>
        
        <!-- Footer -->
        <div class="footer">
            <div>© All materials are copyright scryptIQ 2025</div>
            <div>Powered by Pyodide</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/main.js"></script>
    
    <!-- Pyodide Initialisation Script -->
    <script>

// Generalisable Pyodide Initialisation Script
// Variables and state build up naturally as code blocks execute in order

async function main() {
    // Show loading message for all output elements
    document.querySelectorAll(".output").forEach(el => {
        el.textContent = "Loading Pyodide...";
        el.classList.add("loading-message");
    });
    
    try {
        // Load Pyodide
        console.log("Loading Pyodide...");
        const pyodideStartTime = performance.now();
        let pyodide = await loadPyodide();
        const pyodideLoadTime = performance.now() - pyodideStartTime;
        console.log(`Pyodide loaded in ${pyodideLoadTime.toFixed(2)}ms`);
        
        // Load required packages only if specified
        const lessonPackages = window.LESSON_PACKAGES || [];
        
        if (lessonPackages.length > 0) {
            console.log("Loading required Python packages...");
            const packagesStartTime = performance.now();
            
            // Separate built-in packages from PyPI packages
            const builtInPackages = lessonPackages.filter(pkg => 
                ['numpy', 'scipy', 'matplotlib', 'pandas', 'scikit-learn', 'pillow', 'regex'].includes(pkg)
            );
            
            const micropipPackages = lessonPackages.filter(pkg => !builtInPackages.includes(pkg));
            
            // Load built-in packages (fast)
            if (builtInPackages.length > 0) {
                await pyodide.loadPackage(builtInPackages);
                console.log(`Loaded built-in packages: ${builtInPackages.join(', ')}`);
            }
            
            // Install PyPI packages (slower)
            if (micropipPackages.length > 0) {
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                await micropip.install(micropipPackages);
                console.log(`Installed PyPI packages: ${micropipPackages.join(', ')}`);
            }
            
            const packagesLoadTime = performance.now() - packagesStartTime;
            console.log(`Packages loaded in ${packagesLoadTime.toFixed(2)}ms`);
            console.log(`Total initialisation time: ${(pyodideLoadTime + packagesLoadTime).toFixed(2)}ms`);
        } else {
            console.log("No packages to load for this lesson");
            console.log(`Total initialisation time: ${pyodideLoadTime.toFixed(2)}ms`);
        }

        // Only set up basic Python environment - no pre-loaded variables
        await pyodide.runPythonAsync(`
            import sys
            from io import StringIO
        `);

        // Only set up matplotlib if it's in the loaded packages
        if (lessonPackages.includes('matplotlib')) {
            await pyodide.runPythonAsync(`
                # Set up matplotlib for web rendering
                import matplotlib
                matplotlib.use('AGG')
                import matplotlib.pyplot as plt
                import io
                import base64
                
                def capture_matplotlib():
                    """Capture current matplotlib figure as HTML img tag"""
                    buf = io.BytesIO()
                    plt.savefig(buf, format='png', bbox_inches='tight', dpi=100)
                    buf.seek(0)
                    img_base64 = base64.b64encode(buf.read()).decode('utf-8')
                    plt.close()
                    return f'<img src="data:image/png;base64,{img_base64}" style="max-width: 100%; height: auto;" />'
            `);
            console.log('Matplotlib capture function set up');
        }
        
        console.log("Pyodide loaded successfully");
        
        // Load remote files if URLs are specified
        const lessonFiles = window.LESSON_FILES || [];
        
        if (lessonFiles.length > 0) {
            try {
                console.log(`Checking for ${lessonFiles.length} remote file(s) to load...`);
                
                // Build Python code to load all files dynamically
                let pythonCode = `
from pyodide.http import pyfetch
import os

# Create data directory if it doesn't exist
os.makedirs('./data', exist_ok=True)
`;
                
                // Add loading code for each file
                for (const file of lessonFiles) {
                    if (file.is_binary) {
                        // Binary files (images, etc.) - use bytes
                        pythonCode += `
# Load ${file.filename} (binary)
try:
    response = await pyfetch("${file.url}")
    content = await response.bytes()
    with open('./data/${file.filename}', 'wb') as f:
        f.write(bytes(content))
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                    } else {
                        // Text files (CSV, etc.) - use string
                        pythonCode += `
# Load ${file.filename} (text)
try:
    response = await pyfetch("${file.url}")
    content = await response.string()
    with open('./data/${file.filename}', 'w') as f:
        f.write(content)
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                    }
                }
                
                await pyodide.runPythonAsync(pythonCode);
                console.log("Remote files loaded successfully");
            } catch (error) {
                console.warn("Error loading remote files (continuing anyway):", error);
            }
        } else {
            console.log("No remote files to load for this lesson");
        }
        
        // Function to execute Python code and capture output
        async function executePythonCode(code) {
            try {
                // Redirect Python stdout to capture print statements
                await pyodide.runPythonAsync(`
                    old_stdout = sys.stdout
                    sys.stdout = mystdout = StringIO()
                `);
                
                // Run the user code
                const result = await pyodide.runPythonAsync(code);
                
                // Get the captured stdout
                let stdout = await pyodide.runPythonAsync(`
                    sys.stdout = old_stdout
                    mystdout.getvalue()
                `);
                
                // Check for matplotlib figures only if matplotlib was loaded
                const lessonPackages = window.LESSON_PACKAGES || [];
                if (lessonPackages.includes('matplotlib')) {
                    const hasFigures = await pyodide.runPythonAsync(`
                        import matplotlib.pyplot as plt
                        len(plt.get_fignums()) > 0
                    `);
                    
                    if (hasFigures) {
                        const figureHtml = await pyodide.runPythonAsync(`capture_matplotlib()`);
                        if (stdout) stdout += "\n";
                        stdout += figureHtml;
                    }
                }
                
                // Combine stdout and result
                let output = stdout;
                if (result !== undefined && result !== null && String(result).trim() !== '') {
                    if (output) output += "\n";
                    output += String(result);
                }
                
                return { success: true, output: output || "Code executed successfully (no output)" };
                
            } catch (error) {
                return { success: false, output: "Error: " + error.message };
            }
        }
        
        // Execute all hidden code blocks first (for setup code like imports)
        const hiddenCodeBlocks = Array.from(document.querySelectorAll('.hidden-code textarea'));
        console.log(`Found ${hiddenCodeBlocks.length} hidden code blocks`);

        for (const textarea of hiddenCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            console.log(`Executing hidden code block: ${textarea.id}`);
            console.log(`Hidden code content: ${code.substring(0, 100)}...`);
            const result = await executePythonCode(code);
            
            if (!result.success) {
                console.error(`Error in hidden code block ${textarea.id}:`, result.output);
            } else {
                console.log(`Hidden code block ${textarea.id} executed successfully`);
                console.log(`Result: ${result.output}`);
            }
        }

        console.log("All hidden code blocks executed");
        
        // Get all fixed code blocks in document order
        const fixedCodeBlocks = Array.from(document.querySelectorAll('.code-fixed textarea'));
        
        // Setup and execute fixed code blocks sequentially
        for (const textarea of fixedCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            // Set up CodeMirror editor (read-only)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                readOnly: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding output element
            const outputId = textarea.id + '-output';
            const outputElement = document.getElementById(outputId);
            
            if (outputElement) {
                outputElement.textContent = "Running code...";
                outputElement.classList.add("loading-message");
                
                // Execute the code (this maintains state for subsequent blocks)
                const result = await executePythonCode(code);
                
                // Display the output - check if it's HTML
                const trimmedOutput = result.output.trim();
                console.log('Output length:', trimmedOutput.length);
                console.log('Output starts with:', trimmedOutput.substring(0, 100));
                
                if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                    // It's Plotly HTML output - extract just the body content
                    console.log('Rendering as Plotly HTML');
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.output, 'text/html');
                    // Clear the output element and append the body content
                    outputElement.innerHTML = '';
                    
                    // Find and load external scripts first (like Plotly CDN)
                    const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                    const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                    
                    // Append non-script content first
                    Array.from(doc.body.children).forEach(child => {
                        if (child.tagName !== 'SCRIPT') {
                            outputElement.appendChild(child.cloneNode(true));
                        }
                    });
                    
                    // Load external scripts sequentially
                    const loadScript = (src) => {
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = src;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    };
                    
                    // Load all external scripts first
                    Promise.all(externalScripts.map(s => loadScript(s.src)))
                        .then(() => {
                            console.log('External scripts loaded, executing inline scripts');
                            // Now execute inline scripts
                            inlineScripts.forEach(oldScript => {
                                const newScript = document.createElement('script');
                                newScript.textContent = oldScript.textContent;
                                outputElement.appendChild(newScript);
                            });
                            console.log('Output element after processing:', outputElement.children.length, 'children');
                        })
                        .catch(err => {
                            console.error('Failed to load external scripts:', err);
                            outputElement.textContent = 'Error loading Plotly: ' + err.message;
                        });
                } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                           trimmedOutput.startsWith('<html') ||
                            trimmedOutput.startsWith('<div') ||
                            trimmedOutput.startsWith('<img')) {
                    console.log('Rendering as generic HTML');
                    outputElement.innerHTML = result.output;
                    console.log('Output element after innerHTML:', outputElement.children.length, 'children');
                } else {
                    console.log('Rendering as plain text');
                    outputElement.textContent = result.output;
                }
                outputElement.classList.remove("loading-message");
                if (result.success) {
                    outputElement.classList.add("success-message");
                    outputElement.classList.remove("error-message");
                } else {
                    outputElement.classList.add("error-message");
                    outputElement.classList.remove("success-message");
                }
            }
            
            // Small delay to show progression
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Set flag to indicate all FIXED cells have been executed
        // This is used by PDF generation to ensure all outputs are ready
        window.allCellsExecuted = true;
        console.log("All FIXED cells executed successfully");
        
        // Setup all editable code blocks (but don't execute them)
        document.querySelectorAll('.code-editor textarea').forEach((textarea) => {
            // Set up CodeMirror editor (editable)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding run button and output element
            const baseId = textarea.id;
            const runButtonId = 'run-' + baseId;
            const outputId = baseId + '-output';
            
            const runButton = document.getElementById(runButtonId);
            const outputElement = document.getElementById(outputId);
            
            if (runButton && outputElement) {
                // Set initial state
                outputElement.textContent = "Ready to run code!";
                outputElement.classList.remove("loading-message");
                
                runButton.addEventListener("click", async () => {
                    const code = editor.getValue().trim();
                    if (!code) {
                        outputElement.textContent = "No code to run";
                        return;
                    }
                    
                    outputElement.textContent = "Running...";
                    outputElement.classList.remove("error-message", "success-message");
                    outputElement.classList.add("loading-message");
                    
                    // Execute the code (this also maintains state for future blocks)
                    const result = await executePythonCode(code);
                    
                    // Display the output - check if it's HTML
                    const trimmedOutput = result.output.trim();
                    console.log('Output length:', trimmedOutput.length);
                    console.log('Output starts with:', trimmedOutput.substring(0, 100));
                    
                    if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                        // It's Plotly HTML output - extract just the body content
                        console.log('Rendering as Plotly HTML');
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.output, 'text/html');
                        // Clear the output element and append the body content
                        outputElement.innerHTML = '';
                        
                        // Find and load external scripts first (like Plotly CDN)
                        const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                        const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                        
                        // Append non-script content first
                        Array.from(doc.body.children).forEach(child => {
                            if (child.tagName !== 'SCRIPT') {
                                outputElement.appendChild(child.cloneNode(true));
                            }
                        });
                        
                        // Load external scripts sequentially
                        const loadScript = (src) => {
                            return new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = src;
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        };
                        
                        // Load all external scripts first
                        Promise.all(externalScripts.map(s => loadScript(s.src)))
                            .then(() => {
                                console.log('External scripts loaded, executing inline scripts');
                                // Now execute inline scripts
                                inlineScripts.forEach(oldScript => {
                                    const newScript = document.createElement('script');
                                    newScript.textContent = oldScript.textContent;
                                    outputElement.appendChild(newScript);
                                });
                                console.log('Output element after processing:', outputElement.children.length, 'children');
                            })
                            .catch(err => {
                                console.error('Failed to load external scripts:', err);
                                outputElement.textContent = 'Error loading Plotly: ' + err.message;
                            });
                    } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                               trimmedOutput.startsWith('<html') ||
                               trimmedOutput.startsWith('<div') ||
                               trimmedOutput.startsWith('<img')) {
                        outputElement.innerHTML = result.output;
                    } else {
                        outputElement.textContent = result.output;
                    }
                    outputElement.classList.remove("loading-message");
                    if (result.success) {
                        outputElement.classList.add("success-message");
                        outputElement.classList.remove("error-message");
                    } else {
                        outputElement.classList.add("error-message");
                        outputElement.classList.remove("success-message");
                    }
                });
            }
        });
        
        console.log("All code blocks initialised successfully");

        // Set flag to indicate Pyodide is fully ready
        window.pyodideReady = true;
        console.log("Pyodide fully ready");
        
    } catch (error) {
        console.error("Failed to initialise Pyodide:", error);
        document.querySelectorAll(".output").forEach(el => {
            el.textContent = "Error loading Pyodide: " + error.message;
            el.classList.remove("loading-message");
            el.classList.add("error-message");
        });
    }
}

// Start the application when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
} else {
    main();
}
    </script>
</body>
</html>
    