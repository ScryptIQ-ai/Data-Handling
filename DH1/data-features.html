<!DOCTYPE html>
<html>
<head>
    <!-- MathJax for mathematical notation -->
    <script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']],
            processEscapes: true
        },
        svg: {
            fontCache: 'global'
        }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <!-- Pyodide and CodeMirror -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/pastel-on-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="192x192" href="../assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../assets/android-chrome-512x512.png">
    
    <!-- Core Stylesheets -->
    <link rel="stylesheet" href=../assets/colours-l2d.css>
    <link rel="stylesheet" href="../assets/shared-styles.css">
    <link rel="stylesheet" href="../assets/nav-bar.css">
    <link rel="stylesheet" href="../assets/module_card.css">
    <link rel="stylesheet" href="../assets/learning_outcomes.css">
    <link rel="stylesheet" href="../assets/learning_lists.css">
    <link rel="stylesheet" href="../assets/box_styles.css">
    <link rel="stylesheet" href="../assets/code_styles.css">

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2D - DH1 - Data features</title>
    
    <!-- File URLs for this lesson -->
    <script>
        window.LESSON_FILES = [
            {url: "https://raw.githubusercontent.com/ScryptIQ-ai/lesson-data/refs/heads/main/dh/everleys_data.csv", filename: "everleys_data.csv", is_binary: false},
            {url: "https://raw.githubusercontent.com/ScryptIQ-ai/lesson-data/refs/heads/main/dh/loan_data.csv", filename: "loan_data.csv", is_binary: false}
        ];
        window.LESSON_PACKAGES = ['pandas'];
    </script>
        
</head>
<body>
    
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <a href="../homepage.html" style="text-decoration: none; display: inline-block;">
                <img src="../assets/l2d-brain-logo.png" alt="scryptIQ Logo" class="sidebar-logo">
            </a>
        </div>

        <h3>Content</h3>
        <ul>
            <li><a href="./introduction.html" class="">Introduction</a></li><li><a href="./pandas.html">Pandas</a></li>
            <li>
                <div class="nav-toggle active" data-target="expandable-section-2">
                    Data features
                    <span class="toggle-icon">▼</span>
                </div>
                <ul class="nested-nav expanded" id="expandable-section-2"><li><a href="#introduction">Introduction</a></li><li><a href="#search-for-missing-values">Search for missing values</a></li><li><a href="#basic-data-features">Basic data features</a></li><li><a href="#creating-new-columns">Creating new columns</a></li><li><a href="#filtering-data-in-a-dataframe">Filtering data in a DataFrame</a></li><li><a href="#summary">Summary</a></li>
                </ul>
            </li><li><a href="./data-visualisation.html">Visualisation of data</a></li><li><a href="./diabetes-dataset.html">Diabetes Dataset</a></li><li><a href="./assignment.html">Assignment</a></li><li><a href="./feedback.html">Feedback</a></li>
        </ul>

        <h3 class="collapsible-header collapsed">
            Resources
            <span class="collapse-icon">►</span>
        </h3>
        <div class="collapsible-content collapsed">
            <ul>
                <li><a href="./glossary.html">Glossary</a></li><li><a href="./downloads.html">Downloads</a></li><li><a href="../HB/introduction.html">Handbook</a></li>
            </ul>
        </div>

        <h3>
            <li><a href="./report-issue.html">Report an Issue</a></li>
        </h3>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle">❮</button>
    
    <!-- Main Content Area -->
    <div id="main-content" class="main-content">
        <!-- Top Navigation Bar -->
        <div class="top-navbar">
            <h1 class="page-title">Data Handling 1</h1>
            <div class="nav-actions">
                <a href="../homepage.html" class="text-button" title="Materials homepage">
                    Homepage
                </a>
                <a href="https://learntodiscover.ai/my-cohorts/" class="text-button" title="Find out more about us">
                    Learn to Discover
                </a>
            </div>
        </div>

        
            <div class="module-card" id="introduction">
                <div class="module-header">
                    Data features <span class="module-tag">DH1</span>
                </div>
                <div class="module-body">
                    <h3>Learning Objectives</h3>
                    <div class="learning-outcomes">
                        <div class="outcome-item">
                    <span class="outcome-number">1</span>
                    <span class="outcome-text">Finding and replacing missing values</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">2</span>
                    <span class="outcome-text">Getting basic statistics per feature such as mean, medium, std</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">3</span>
                    <span class="outcome-text">Filtering DataFrames given a condition in a column</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">4</span>
                    <span class="outcome-text">How to create new columns based of data in existing columns</span>
                </div>
                    </div>
                    <h3>Introduction</h3>
                    <p>The first path you should take with any new dataset is to inspect and understand what you&#x27;re working with. This includes checking for and replacing missing values, which <em>pandas</em> reads in for you without error, and to understand the basic statistics of your columns to see how they&#x27;re distributed or centered.</p>
                </div>
            </div>
            
            <div class="module-card" id="search-for-missing-values">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Search for missing values</h3>
                        <p>Some tables contain missing entries. You can check a DataFrame for such missing entries. If no missing entry is found, the function <code>isnull</code> will return <code>False</code>.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-22"># Once again lets load in our dataset

from pandas import read_csv

df = read_csv(&quot;./data/everleys_data.csv&quot;)</textarea>
            </div>
            <div id="code-cell-22-output" class="output" style="display: none;"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-23">df.isnull().any()</textarea>
            </div>
            <div id="code-cell-23-output" class="output"></div>
        </div>
        <p>This shows that there are are missing entries in both our columns in the DataFrame, the <code>NaN</code> values you can see in each column. <code>NaN</code> values are the Python standard way of representing missing values.</p><p>These often need to be replaced as analytical, visualisation, and machine learning tools will not accept them. We can do this with the Pandas method <code>.fillna()</code>. This method will replace all <em>null</em> values with your given value, typically <code>0</code> or sometimes the mean value of column.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-24">replacement_values = {&quot;calcium&quot; : 0, &quot;sodium&quot; : 0}

df = df.fillna(value = replacement_values)
df.head(8)</textarea>
            </div>
            <div id="code-cell-24-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="search-for-missing-values">
                <div class="module-body">
                    <div class="module-section">
                        
        <div class="info-box practice-exercise-box">
            <div class="box-title">
                <span class="box-icon"></span>
                PRACTICE EXERCISE
            </div>
            <div class="box-content">
                <p><strong>1.</strong></p>
                <p>Load in the loan dataset, &#x27;loan_data.csv&#x27;:<ul class="nested-list"><li>Check all columns for any <em>null</em> values</li><br><li>Use slicing to view the rows from index 6 to (and including) index 10, which of these rows contain <em>null</em> values and where?</li><br><li>Only replace the null values in the column with <em>null</em> values from the previous question. Choose an appropriate value given the other column values.</li></ul></p>
            </div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-editor">
                <textarea id="code-cell-25"></textarea>
            </div>
            <button id="run-code-cell-25" class="run-button">Run Code</button>
            <div id="code-cell-25-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="basic-data-features">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Basic data features</h3>
                        <h4>Summary Statistics</h4>
        <div class="video-container">
            <iframe 
                src="https://www.youtube.com/embed/zw6t3yHEqGU"
                width="560"
                height="315"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
            </iframe>
        </div>
        <p>To get a summary of basic data features, it is possible to use the function <code>describe</code>:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-26">description = df.describe()
description</textarea>
            </div>
            <div id="code-cell-26-output" class="output"></div>
        </div>
        <p>The <code>describe</code> function produces a new DataFrame (here called &#x27;description&#x27;) that contains the number of samples, the mean, the standard deviation, 25th, 50th, 75th percentile, and the minimum and maximum values for each column of the data. Note that the indices of the rows have now been replaced by strings. To access rows, it is possible to refer to those names using the <code>loc</code> property. Thus, in order to access the mean of the calcium concentrations from the description, each of the following is valid:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-27"># Option 1
description.loc[&#x27;mean&#x27;][&#x27;calcium&#x27;]</textarea>
            </div>
            <div id="code-cell-27-output" class="output"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-28"># Option 2
description.loc[&#x27;mean&#x27;][0]</textarea>
            </div>
            <div id="code-cell-28-output" class="output"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-29"># Option 3
description[&#x27;calcium&#x27;][&#x27;mean&#x27;]</textarea>
            </div>
            <div id="code-cell-29-output" class="output"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-30"># Option 4
description[&#x27;calcium&#x27;][1]</textarea>
            </div>
            <div id="code-cell-30-output" class="output"></div>
        </div>
        <p>While the <code>describe</code> method provides a convenient statistical summary, you can also compute individual statistics directly using specific methods provided in the Pandas library. These include <code>.sum()</code>, <code>.mean()</code>, and <code>.std()</code>, which calculate the sum, mean and standard deviation of each column, respectively. These methods return what is known as a Pandas Series, which is where each entry corresponds to a column in the DataFrame.<br><br>Internally, these rely on NumPy functions and provide the same results as if you applied <code>numpy.sum()</code> or <code>numpy.mean()</code> directly to each column.<br><br>It is important to note that Pandas is built on top of NumPy, acting as a high-level wrapper around many of its core numerical operations. When you use methods like <code>.sum()</code> or <code>.mean()</code> on a DataFrame or Series, Pandas delegates the computation to the corresponding NumPy function, behind the scenes. This allows Pandas to combine the speed and efficiency of NumPy together with more intuitive, table-like data structures and labels - which is Pandas&#x27; strength. The result is easier-to-read code combined with the same numerical reliability as NumPy.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-31"># Calculate individual statistics on the DataFrame
column_sums = df.sum()
column_means = df.mean()
column_stds = df.std()
print(&quot;Column sums:&quot;)
print(column_sums)
print(&quot;\nColumn means:&quot;)
print(column_means)
print(&quot;\nColumn standard deviations:&quot;)
print(column_stds)</textarea>
            </div>
            <div id="code-cell-31-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="basic-data-features">
                <div class="module-body">
                    <div class="module-section">
                        
        <div class="info-box practice-exercise-box">
            <div class="box-title">
                <span class="box-icon"></span>
                PRACTICE EXERCISE
            </div>
            <div class="box-content">
                <p><strong>2.</strong></p>
                <p>Find and use your own .csv dataset to practice. (If you don&#x27;t have a dataset at hand, any excel table can be exported as .csv.):<ul class="nested-list"><li>Firstly, read it into a DataFrame, and proceed by checking its header, accessing individual values or sets of values etc.</li><br><li>Create a statistical summary using <code>describe</code>, and check for missing values using <code>.isnull</code>.</li></ul></p>
            </div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="creating-new-columns">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Creating new columns</h3>
                        <p>Pandas DataFrames are mutable objects that can have new columns of data added to them at any time. The only pre-requisite is that the newly added data must be the same length as the DataFrame, so that it matches.<br><br>To create a new column we simply assign a new column name in between the square brackets <code>[]</code>: much as though we were accessing a pre-existing column. This way, we have assigned a new data array to it.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-32"># We can guarantee a new column is the same length by using len(df)
# The range() function returns a list that starts with 0, 
# increasing sequentially to the given value

df[&#x27;new_column&#x27;] = list(range(len(df)))
df.head()</textarea>
            </div>
            <div id="code-cell-32-output" class="output"></div>
        </div>
        
        <div class="info-box warning-box">
            <div class="box-title">
                <span class="box-icon"></span>
                WARNING
            </div>
            <div class="box-content">
                <p>Try to not include spaces in the lables of your column headings. Spaces can lead to reading errors later down the line and are not always visible.</p>
            </div>
        </div>
        <p>However, we will seldom wish to add new data to a DataFrame. More often, we&#x27;ll want to add a new data column based off of, for instance, a combination of data columns, or a satisfied (or unsatisfied) logical condition. All of the mathmatical operators <code>+, -, <em>, /, </em>*, …</code> or logical operators <code>&lt;, &gt;, ==, …</code> will work row-wise when applied to one or more columns.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-33"># Mathematical operators can be applied to singular columns:

df[&#x27;calcium_squared&#x27;] = df[&#x27;calcium&#x27;] ** 2
df.head()</textarea>
            </div>
            <div id="code-cell-33-output" class="output"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-34"># They can also be applied between columns:

df[&#x27;sodium_minus_calcium&#x27;] = df[&#x27;sodium&#x27;] - df[&#x27;calcium&#x27;]
df.head()</textarea>
            </div>
            <div id="code-cell-34-output" class="output"></div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-35"># Logical operators can also be used to create a True/False column based on a condition:

df[&#x27;high_sodium&#x27;] = df[&#x27;sodium&#x27;] &gt; 130
df.head()</textarea>
            </div>
            <div id="code-cell-35-output" class="output"></div>
        </div>
        <p>To remove a column, you can use the <code>.drop()</code> method to remove or drop the new columns of data. (Note: we are only doing this for aesthetic reasons, to keep subsequent cells in this tutorial less congested). To find out more information about .drop() and other methods, please read through <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.drop.html">Pandas&#x27; official documentation.</a></p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-36"># Use the .drop() method to remove columns, specified inside a list:

df.drop(columns = [&quot;new_column&quot;, &quot;calcium_squared&quot;, &quot;sodium_minus_calcium&quot; ], inplace = True)

# Note the optional argument &#x27;inplace = True&#x27; ensures that the old DataFrame is overwritten with
# the specified changes being made. If the value is set to &#x27;False&#x27; a copy is returned, instead.

df.head()</textarea>
            </div>
            <div id="code-cell-36-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="filtering-data-in-a-dataframe">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Filtering data in a DataFrame</h3>
                        <p>Often, an analysis of a dataset may be required only on part of the data. This can often be formulated by using a logical condition which specifies the required subset.<br><br>If we assign the result of the conditional statement (such as the conditional we wrote to define the <code>high_sodium</code> column, earlier in the lesson) then this variable can act as a template with which we can filter the data. If we call the DataFrame with that variable, we will only get the rows where the condition was found to be true:</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-37">high_sodium_filter = df[&#x27;sodium&#x27;] &gt; 130
df[high_sodium_filter]</textarea>
            </div>
            <div id="code-cell-37-output" class="output"></div>
        </div>
        <p>We can also use filtering to select just one row. This can be useful when cleaning data that contains <em>null</em> values, as you can see the other information and decide if its worth keeping. Or just when you want to extract the data of given, interesting data point.</p>
        <div class="code-area">
            <div class="code-container code-fixed">
                <textarea id="code-cell-38"># We&#x27;ll use the loan dataset as it has columns with strings

loan_df = read_csv(&quot;./data/loan_data.csv&quot;)

# Using == will find the row(s) containing &quot;LP002980&quot;
# Placing it inside square brackets chains this Pandas logic together

loan_df[loan_df[&#x27;Loan_ID&#x27;] == &quot;LP002980&quot;]</textarea>
            </div>
            <div id="code-cell-38-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="filtering-data-in-a-dataframe">
                <div class="module-body">
                    <div class="module-section">
                        
        <div class="info-box practice-exercise-box">
            <div class="box-title">
                <span class="box-icon"></span>
                PRACTICE EXERCISE
            </div>
            <div class="box-content">
                <p><strong>3.</strong></p>
                <p>Using the everleys dataset, write a short block of code to create a <code>low_sodium</code> column.<ul class="nested-list"><li>Filter the dataset to only include rows where <code>low_sodium</code> is True</li></ul></p>
            </div>
        </div>
        
        <div class="code-area">
            <div class="code-container code-editor">
                <textarea id="code-cell-39"></textarea>
            </div>
            <button id="run-code-cell-39" class="run-button">Run Code</button>
            <div id="code-cell-39-output" class="output"></div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="summary">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Summary</h3>
                        <p>The ease at which you can enrich your dataset by adding new column based of existing data and the ability to filter the whole dataset based on a conditional applied to a singular (or multiple) columns is what makes <em>pandas</em> such a powerful tool for the data scientist. You can create complex pipelines that pull in, transform, and analyse a dataset all dependent on multiple conditions you set throughout.</p>
                    </div>
                </div>
            </div>
            
        
        <div class="page-navigation">
            <a href="./pandas.html" class="nav-button prev">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                Previous
            </a>
            <a href="./data-visualisation.html" class="nav-button next">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </a></div>
        
        <!-- Footer -->
        <div class="footer">
            <div>© All materials are copyright scryptIQ 2025</div>
            <div>Powered by Pyodide</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/main.js"></script>
    
    <!-- Pyodide Initialisation Script -->
    <script>

// Generalisable Pyodide Initialisation Script
// Variables and state build up naturally as code blocks execute in order

async function main() {
    // Show loading message for all output elements
    document.querySelectorAll(".output").forEach(el => {
        el.textContent = "Loading Pyodide...";
        el.classList.add("loading-message");
    });
    
    try {
        // Load Pyodide
        console.log("Loading Pyodide...");
        const pyodideStartTime = performance.now();
        let pyodide = await loadPyodide();
        const pyodideLoadTime = performance.now() - pyodideStartTime;
        console.log(`Pyodide loaded in ${pyodideLoadTime.toFixed(2)}ms`);
        
        // Load required packages only if specified
        const lessonPackages = window.LESSON_PACKAGES || [];
        
        if (lessonPackages.length > 0) {
            console.log("Loading required Python packages...");
            const packagesStartTime = performance.now();
            
            // Separate built-in packages from PyPI packages
            const builtInPackages = lessonPackages.filter(pkg => 
                ['numpy', 'scipy', 'matplotlib', 'pandas', 'scikit-learn', 'pillow', 'regex'].includes(pkg)
            );
            
            const micropipPackages = lessonPackages.filter(pkg => !builtInPackages.includes(pkg));
            
            // Load built-in packages (fast)
            if (builtInPackages.length > 0) {
                await pyodide.loadPackage(builtInPackages);
                console.log(`Loaded built-in packages: ${builtInPackages.join(', ')}`);
            }
            
            // Install PyPI packages (slower)
            if (micropipPackages.length > 0) {
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                await micropip.install(micropipPackages);
                console.log(`Installed PyPI packages: ${micropipPackages.join(', ')}`);
            }
            
            const packagesLoadTime = performance.now() - packagesStartTime;
            console.log(`Packages loaded in ${packagesLoadTime.toFixed(2)}ms`);
            console.log(`Total initialisation time: ${(pyodideLoadTime + packagesLoadTime).toFixed(2)}ms`);
        } else {
            console.log("No packages to load for this lesson");
            console.log(`Total initialisation time: ${pyodideLoadTime.toFixed(2)}ms`);
        }

        // Only set up basic Python environment - no pre-loaded variables
        await pyodide.runPythonAsync(`
            import sys
            from io import StringIO
        `);

        // Only set up matplotlib if it's in the loaded packages
        if (lessonPackages.includes('matplotlib')) {
            await pyodide.runPythonAsync(`
                # Set up matplotlib for web rendering
                import matplotlib
                matplotlib.use('AGG')
                import matplotlib.pyplot as plt
                import io
                import base64
                
                def capture_matplotlib():
                    """Capture current matplotlib figure as HTML img tag"""
                    buf = io.BytesIO()
                    plt.savefig(buf, format='png', bbox_inches='tight', dpi=100)
                    buf.seek(0)
                    img_base64 = base64.b64encode(buf.read()).decode('utf-8')
                    plt.close()
                    return f'<img src="data:image/png;base64,{img_base64}" style="max-width: 100%; height: auto;" />'
            `);
            console.log('Matplotlib capture function set up');
        }
        
        console.log("Pyodide loaded successfully");
        
        // Load remote files if URLs are specified
        const lessonFiles = window.LESSON_FILES || [];
        
        if (lessonFiles.length > 0) {
            try {
                console.log(`Checking for ${lessonFiles.length} remote file(s) to load...`);
                
                // Build Python code to load all files dynamically
                let pythonCode = `
from pyodide.http import pyfetch
import os

# Create data directory if it doesn't exist
os.makedirs('./data', exist_ok=True)
`;
                
                // Add loading code for each file
                for (const file of lessonFiles) {
                    if (file.is_binary) {
                        // Binary files (images, etc.) - use bytes
                        pythonCode += `
# Load ${file.filename} (binary)
try:
    response = await pyfetch("${file.url}")
    content = await response.bytes()
    with open('./data/${file.filename}', 'wb') as f:
        f.write(bytes(content))
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                    } else {
                        // Text files (CSV, etc.) - use string
                        pythonCode += `
# Load ${file.filename} (text)
try:
    response = await pyfetch("${file.url}")
    content = await response.string()
    with open('./data/${file.filename}', 'w') as f:
        f.write(content)
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                    }
                }
                
                await pyodide.runPythonAsync(pythonCode);
                console.log("Remote files loaded successfully");
            } catch (error) {
                console.warn("Error loading remote files (continuing anyway):", error);
            }
        } else {
            console.log("No remote files to load for this lesson");
        }
        
        // Function to execute Python code and capture output
        async function executePythonCode(code) {
            try {
                // Redirect Python stdout to capture print statements
                await pyodide.runPythonAsync(`
                    old_stdout = sys.stdout
                    sys.stdout = mystdout = StringIO()
                `);
                
                // Run the user code
                const result = await pyodide.runPythonAsync(code);
                
                // Get the captured stdout
                let stdout = await pyodide.runPythonAsync(`
                    sys.stdout = old_stdout
                    mystdout.getvalue()
                `);
                
                // Check for matplotlib figures only if matplotlib was loaded
                const lessonPackages = window.LESSON_PACKAGES || [];
                if (lessonPackages.includes('matplotlib')) {
                    const hasFigures = await pyodide.runPythonAsync(`
                        import matplotlib.pyplot as plt
                        len(plt.get_fignums()) > 0
                    `);
                    
                    if (hasFigures) {
                        const figureHtml = await pyodide.runPythonAsync(`capture_matplotlib()`);
                        if (stdout) stdout += "\n";
                        stdout += figureHtml;
                    }
                }
                
                // Combine stdout and result
                let output = stdout;
                if (result !== undefined && result !== null && String(result).trim() !== '') {
                    if (output) output += "\n";
                    output += String(result);
                }
                
                return { success: true, output: output || "Code executed successfully (no output)" };
                
            } catch (error) {
                return { success: false, output: "Error: " + error.message };
            }
        }
        
        // Execute all hidden code blocks first (for setup code like imports)
        const hiddenCodeBlocks = Array.from(document.querySelectorAll('.hidden-code textarea'));
        console.log(`Found ${hiddenCodeBlocks.length} hidden code blocks`);

        for (const textarea of hiddenCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            console.log(`Executing hidden code block: ${textarea.id}`);
            console.log(`Hidden code content: ${code.substring(0, 100)}...`);
            const result = await executePythonCode(code);
            
            if (!result.success) {
                console.error(`Error in hidden code block ${textarea.id}:`, result.output);
            } else {
                console.log(`Hidden code block ${textarea.id} executed successfully`);
                console.log(`Result: ${result.output}`);
            }
        }

        console.log("All hidden code blocks executed");
        
        // Get all fixed code blocks in document order
        const fixedCodeBlocks = Array.from(document.querySelectorAll('.code-fixed textarea'));
        
        // Setup and execute fixed code blocks sequentially
        for (const textarea of fixedCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            // Set up CodeMirror editor (read-only)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                readOnly: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding output element
            const outputId = textarea.id + '-output';
            const outputElement = document.getElementById(outputId);
            
            if (outputElement) {
                outputElement.textContent = "Running code...";
                outputElement.classList.add("loading-message");
                
                // Execute the code (this maintains state for subsequent blocks)
                const result = await executePythonCode(code);
                
                // Display the output - check if it's HTML
                const trimmedOutput = result.output.trim();
                console.log('Output length:', trimmedOutput.length);
                console.log('Output starts with:', trimmedOutput.substring(0, 100));
                
                if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                    // It's Plotly HTML output - extract just the body content
                    console.log('Rendering as Plotly HTML');
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.output, 'text/html');
                    // Clear the output element and append the body content
                    outputElement.innerHTML = '';
                    
                    // Find and load external scripts first (like Plotly CDN)
                    const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                    const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                    
                    // Append non-script content first
                    Array.from(doc.body.children).forEach(child => {
                        if (child.tagName !== 'SCRIPT') {
                            outputElement.appendChild(child.cloneNode(true));
                        }
                    });
                    
                    // Load external scripts sequentially
                    const loadScript = (src) => {
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = src;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    };
                    
                    // Load all external scripts first
                    Promise.all(externalScripts.map(s => loadScript(s.src)))
                        .then(() => {
                            console.log('External scripts loaded, executing inline scripts');
                            // Now execute inline scripts
                            inlineScripts.forEach(oldScript => {
                                const newScript = document.createElement('script');
                                newScript.textContent = oldScript.textContent;
                                outputElement.appendChild(newScript);
                            });
                            console.log('Output element after processing:', outputElement.children.length, 'children');
                        })
                        .catch(err => {
                            console.error('Failed to load external scripts:', err);
                            outputElement.textContent = 'Error loading Plotly: ' + err.message;
                        });
                } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                           trimmedOutput.startsWith('<html') ||
                            trimmedOutput.startsWith('<div') ||
                            trimmedOutput.startsWith('<img')) {
                    console.log('Rendering as generic HTML');
                    outputElement.innerHTML = result.output;
                    console.log('Output element after innerHTML:', outputElement.children.length, 'children');
                } else {
                    console.log('Rendering as plain text');
                    outputElement.textContent = result.output;
                }
                outputElement.classList.remove("loading-message");
                if (result.success) {
                    outputElement.classList.add("success-message");
                    outputElement.classList.remove("error-message");
                } else {
                    outputElement.classList.add("error-message");
                    outputElement.classList.remove("success-message");
                }
            }
            
            // Small delay to show progression
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Set flag to indicate all FIXED cells have been executed
        // This is used by PDF generation to ensure all outputs are ready
        window.allCellsExecuted = true;
        console.log("All FIXED cells executed successfully");
        
        // Setup all editable code blocks (but don't execute them)
        document.querySelectorAll('.code-editor textarea').forEach((textarea) => {
            // Set up CodeMirror editor (editable)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding run button and output element
            const baseId = textarea.id;
            const runButtonId = 'run-' + baseId;
            const outputId = baseId + '-output';
            
            const runButton = document.getElementById(runButtonId);
            const outputElement = document.getElementById(outputId);
            
            if (runButton && outputElement) {
                // Set initial state
                outputElement.textContent = "Ready to run code!";
                outputElement.classList.remove("loading-message");
                
                runButton.addEventListener("click", async () => {
                    const code = editor.getValue().trim();
                    if (!code) {
                        outputElement.textContent = "No code to run";
                        return;
                    }
                    
                    outputElement.textContent = "Running...";
                    outputElement.classList.remove("error-message", "success-message");
                    outputElement.classList.add("loading-message");
                    
                    // Execute the code (this also maintains state for future blocks)
                    const result = await executePythonCode(code);
                    
                    // Display the output - check if it's HTML
                    const trimmedOutput = result.output.trim();
                    console.log('Output length:', trimmedOutput.length);
                    console.log('Output starts with:', trimmedOutput.substring(0, 100));
                    
                    if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                        // It's Plotly HTML output - extract just the body content
                        console.log('Rendering as Plotly HTML');
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.output, 'text/html');
                        // Clear the output element and append the body content
                        outputElement.innerHTML = '';
                        
                        // Find and load external scripts first (like Plotly CDN)
                        const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                        const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                        
                        // Append non-script content first
                        Array.from(doc.body.children).forEach(child => {
                            if (child.tagName !== 'SCRIPT') {
                                outputElement.appendChild(child.cloneNode(true));
                            }
                        });
                        
                        // Load external scripts sequentially
                        const loadScript = (src) => {
                            return new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = src;
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        };
                        
                        // Load all external scripts first
                        Promise.all(externalScripts.map(s => loadScript(s.src)))
                            .then(() => {
                                console.log('External scripts loaded, executing inline scripts');
                                // Now execute inline scripts
                                inlineScripts.forEach(oldScript => {
                                    const newScript = document.createElement('script');
                                    newScript.textContent = oldScript.textContent;
                                    outputElement.appendChild(newScript);
                                });
                                console.log('Output element after processing:', outputElement.children.length, 'children');
                            })
                            .catch(err => {
                                console.error('Failed to load external scripts:', err);
                                outputElement.textContent = 'Error loading Plotly: ' + err.message;
                            });
                    } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                               trimmedOutput.startsWith('<html') ||
                               trimmedOutput.startsWith('<div') ||
                               trimmedOutput.startsWith('<img')) {
                        outputElement.innerHTML = result.output;
                    } else {
                        outputElement.textContent = result.output;
                    }
                    outputElement.classList.remove("loading-message");
                    if (result.success) {
                        outputElement.classList.add("success-message");
                        outputElement.classList.remove("error-message");
                    } else {
                        outputElement.classList.add("error-message");
                        outputElement.classList.remove("success-message");
                    }
                });
            }
        });
        
        console.log("All code blocks initialised successfully");

        // Set flag to indicate Pyodide is fully ready
        window.pyodideReady = true;
        console.log("Pyodide fully ready");
        
    } catch (error) {
        console.error("Failed to initialise Pyodide:", error);
        document.querySelectorAll(".output").forEach(el => {
            el.textContent = "Error loading Pyodide: " + error.message;
            el.classList.remove("loading-message");
            el.classList.add("error-message");
        });
    }
}

// Start the application when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
} else {
    main();
}
    </script>
</body>
</html>
    